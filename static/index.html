<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Live 1m Candles</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { margin:0; background:#000; color:#fff; font-family:Arial; padding:10px; }
        h1 { text-align:center; margin:20px 0 30px; }
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; max-width:1600px; margin:auto; }
        .card { background:#111; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.8); }
        .header { padding:12px; text-align:center; font-size:1.4em; font-weight:bold; background:#1a1a1a; }
        .price { font-size:1.2em; margin-top:4px; }
        #chart-btc, #chart-eth, #chart-bnb, #chart-sol { width:100%; height:380px; }
        @media (max-width:1100px) { .grid { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <h1>Binance — Real-Time 1-Minute Candles</h1>
    <div class="grid">
        <div class="card">
            <div class="header">BTC/USDT <span class="price" id="p-btc">—</span></div>
            <div id="chart-btc"></div>
        </div>
        <div class="card">
            <div class="header">ETH/USDT <span class="price" id="p-eth">—</span></div>
            <div id="chart-eth"></div>
        </div>
        <div class="card">
            <div class="header">BNB/USDT <span class="price" id="p-bnb">—</span></div>
            <div id="chart-bnb"></div>
        </div>
        <div class="card">
            <div class="header">SOL/USDT <span class="price" id="p-sol">—</span></div>
            <div id="chart-sol"></div>
        </div>
    </div>

    <script>
        const symbols = { BTCUSDT: "btc", ETHUSDT: "eth", BNBUSDT: "bnb", SOLUSDT: "sol" };
        const series = {};
        const charts = {};

        Object.entries(symbols).forEach(([symbol, id]) => {
            const chart = LightweightCharts.createChart(document.getElementById(`chart-${id}`), {
                layout: { background: { color: '#111' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
                width: 600,
                height: 380,
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,

                    barSpacing: 12, 
                    rightOffset: 10,
                    minBarSpacing: 4,
                    maxBarSpacing: 30,
                    lockVisibleTimeRangeOnResize: true,
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            });

            const candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00c087',
                downColor: '#f23645',
                borderVisible: false,
                wickUpColor: '#00c087',
                wickDownColor: '#f23645',
            });

            charts[symbol] = chart;
            series[symbol] = candlestickSeries;

            chart.priceScale("right").applyOptions({
                autoScale: true,
                scaleMargins: { top: 0.1, bottom: 0.2 },
            });

            const now = Math.floor(Date.now() / 60000);
            chart.timeScale().setVisibleRange({
                from: (now - 30) * 60,
                to: (now + 5) * 60,
            });
        });

        const ws = new WebSocket(`ws://${location.host}/ws`);

        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);

            if (msg.type === "history") {
                Object.entries(msg.data).forEach(([symbol, candles]) => {
                    candles.forEach(c => {
                        series[symbol].update({
                            time: c.start / 1000,
                            open: +c.open,
                            high: +c.high,
                            low: +c.low,
                            close: +c.close
                        });
                    });
                });

                Object.values(charts).forEach(chart => {
                    chart.timeScale().fitContent();
                });
                return;
            }

            if (msg.type !== "candles") return;

            Object.entries(msg.data).forEach(([symbol, c]) => {
                if (!c.open) return;

                const time = c.start / 1000;
                const candle = {
                    time: time,
                    open: +c.open,
                    high: +c.high,
                    low: +c.low,
                    close: +c.close
                };

                series[symbol].update(candle);

                const el = document.getElementById(`p-${symbols[symbol]}`);
                const price = +c.close;
                el.textContent = `$${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}`;
                el.style.color = c.close >= c.open ? '#00c087' : '#f23645';
            });
        };

        ws.onopen = () => console.log("WebSocket подключён – ждём историю...");
    </script>
</body>
</html>